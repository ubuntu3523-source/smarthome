<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Web Serial ìŠ¤ë§ˆíŠ¸ í•˜ìš°ìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ (ìˆ˜ì • ì™„ë£Œ)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; padding: 20px; border-radius: 8px; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        #connectButton { background-color: #4CAF50; color: white; }
        #connectButton:hover { background-color: #45a049; }
        .control-group { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 10px; }
        #status { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #e9ecef; white-space: pre-wrap; }
        .data-display { margin-top: 10px; padding: 10px; border: 1px solid #007bff; background-color: #eaf6ff; border-radius: 5px; font-size: 1.1em; }
        .data-display span { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ìŠ¤ë§ˆíŠ¸ í•˜ìš°ìŠ¤ Web Serial ì»¨íŠ¸ë¡¤ëŸ¬ ğŸ </h2>
        <button id="connectButton">ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° (Baud Rate: 115200)</button>

        <div class="data-display">
            ì˜¨ë„: <span id="tempDisplay">--</span> Â°C<br>
            ìŠµë„: <span id="humidityDisplay">--</span> %
        </div>

        <div class="control-group">
            <label>ğŸ’¡ NeoPixel LED ì œì–´</label>
            <button onclick="sendSerialData('n')" style="background-color: #ffc107;">ì¼œê¸° (í°ìƒ‰)</button>
            <button onclick="sendSerialData('f')" style="background-color: #dc3545; color: white;">ë„ê¸° (ê²€ì€ìƒ‰)</button>
        </div>

        <div class="control-group">
            <label for="servoAngle">âš™ï¸ ì„œë³´ ëª¨í„° ê°ë„ ì œì–´ (<span id="angleValue">0</span>Â°)</label>
            <input type="range" id="servoAngle" min="0" max="180" value="0" step="1" oninput="updateAngle(this.value)">
            <button onclick="sendServoAngle()" style="background-color: #007bff; color: white;">ê°ë„ ì „ì†¡</button>
        </div>

        <div id="status">ìƒíƒœ: ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
    </div>

    <script>
        const BAUD_RATE = 115200;
        let port;
        let inputDone;
        let outputDone;
        let outputStream;

        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        const tempDisplay = document.getElementById('tempDisplay');
        const humidityDisplay = document.getElementById('humidityDisplay');
        const angleValueSpan = document.getElementById('angleValue');
        const servoAngleInput = document.getElementById('servoAngle');

        connectButton.addEventListener('click', () => {
            if (port) {
                disconnect();
            } else {
                connect();
            }
        });

        // ì„œë³´ ëª¨í„° ê°ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateAngle(value) {
            angleValueSpan.textContent = value;
        }

        // ì‹œë¦¬ì–¼ ì—°ê²°
        async function connect() {
            try {
                // í¬íŠ¸ ìš”ì²­ ë° ì—´ê¸°
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: BAUD_RATE });
                statusDiv.textContent = `ìƒíƒœ: í¬íŠ¸ ì—°ê²°ë¨ (${BAUD_RATE}bps)`;
                connectButton.textContent = 'ì—°ê²° í•´ì œ';

                // ë°ì´í„° ìˆ˜ì‹  ì‹œì‘ (ìˆ˜ì •ëœ readLoop ì‚¬ìš©)
                readLoop();

                // ë°ì´í„° ì†¡ì‹  ì„¤ì •
                outputStream = port.writable.getWriter();
                outputDone = true;

            } catch (error) {
                statusDiv.textContent = `ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                port = null; // ì—°ê²° ì‹¤íŒ¨ ì‹œ port ì´ˆê¸°í™”
            }
        }

        // ì‹œë¦¬ì–¼ ì—°ê²° í•´ì œ
        async function disconnect() {
            // ì†¡ì‹  ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
            if (outputStream) {
                await outputStream.close();
                outputStream = null;
            }
            
            // ìˆ˜ì‹  ìŠ¤íŠ¸ë¦¼ ë° í¬íŠ¸ ë‹«ê¸°
            if (port) {
                // port.close()ëŠ” pipeToë¡œ ì—°ê²°ëœ íŒŒì´í”„ë¼ì¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì¢…ë£Œì‹œí‚µë‹ˆë‹¤.
                // inputDoneì„ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´ port.close()ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                await port.close(); 
                port = null;
            }
            
            inputDone = null; // íŒŒì´í”„ë¼ì¸ ìƒíƒœ ì´ˆê¸°í™”
            statusDiv.textContent = 'ìƒíƒœ: ì—°ê²° í•´ì œë¨';
            connectButton.textContent = 'ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²°';
        }

        // ğŸ’¡ ìˆ˜ì •ëœ ì‹œë¦¬ì–¼ ë°ì´í„° ìˆ˜ì‹  ë£¨í”„: pipeToë§Œì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¼ Lock ì˜¤ë¥˜ ë°©ì§€
        async function readLoop() {
            const textDecoder = new TextDecoder();
            
            // port.readable ìŠ¤íŠ¸ë¦¼ì„ ë””ì½”ë” ë³€í™˜ ìŠ¤íŠ¸ë¦¼ì„ ê±°ì³ WritableStreamìœ¼ë¡œ íŒŒì´í”„
            inputDone = port.readable
                .pipeThrough(new TransformStream({
                    transform(chunk, controller) {
                        // ìˆ˜ì‹ ëœ Uint8Array ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë””ì½”ë”©í•˜ì—¬ ë‹¤ìŒ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ë‹¬
                        const decodedText = textDecoder.decode(chunk, {stream: true});
                        controller.enqueue(decodedText);
                    }
                }))
                .pipeTo(new WritableStream({
                    async write(value) {
                        // ë””ì½”ë”©ëœ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì²˜ë¦¬
                        processSerialData(value);
                    }
                }))
                .catch(error => {
                    // ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìœ¼ë‚˜ portê°€ ì•„ì§ ì—°ê²° ìƒíƒœë¼ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                    if (port) {
                        statusDiv.textContent = `ìƒíƒœ: ìˆ˜ì‹  íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì—°ê²° í•´ì œ ì‹œë„
                        disconnect(); 
                    }
                });
        }

        // ìˆ˜ì‹ ëœ ë°ì´í„°ë¥¼ ì²˜ë¦¬ (ì˜¨ìŠµë„)
        function processSerialData(data) {
            // ë°ì´í„°ê°€ í•œ ë²ˆì— ì—¬ëŸ¬ ì¤„ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¤„ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
            const lines = data.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                // ì•„ë‘ì´ë…¸ì—ì„œ ì „ì†¡í•˜ëŠ” ì˜¨ìŠµë„ í˜•ì‹: "ì˜¨ë„,ìŠµë„"
                if (trimmedLine.includes(',')) {
                    const [temp, humidity] = trimmedLine.split(',');
                    const fTemp = parseFloat(temp);
                    const fHumidity = parseFloat(humidity);

                    if (!isNaN(fTemp) && !isNaN(fHumidity)) {
                        tempDisplay.textContent = fTemp.toFixed(2);
                        humidityDisplay.textContent = fHumidity.toFixed(2);
                    }
                }
            });
        }

        // ì‹œë¦¬ì–¼ ë°ì´í„° ì „ì†¡
        async function sendSerialData(data) {
            if (!port || !outputStream) {
                statusDiv.textContent = 'ì˜¤ë¥˜: ë¨¼ì € í¬íŠ¸ì— ì—°ê²°í•˜ì„¸ìš”.';
                return;
            }
            try {
                const encoder = new TextEncoder();
                // ì „ì†¡í•  ë°ì´í„°ì— ê°œí–‰ ë¬¸ìë‚˜ ìºë¦¬ì§€ ë¦¬í„´ì„ ì¶”ê°€í•  í•„ìš”ëŠ” ì—†ìœ¼ë‚˜
                // ì•„ë‘ì´ë…¸ì˜ Serial.read()ëŠ” ë‹¨ì¼ ë¬¸ìë¥¼ ì½ìœ¼ë¯€ë¡œ ë¬¸ìì—´ ì „ì†¡ ì‹œ ì£¼ì˜
                await outputStream.write(encoder.encode(data));
                statusDiv.textContent = `ìƒíƒœ: '${data}' ëª…ë ¹ì–´ ì „ì†¡ ì™„ë£Œ.`;
            } catch (error) {
                statusDiv.textContent = `ì˜¤ë¥˜: ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // ì„œë³´ ê°ë„ ì „ì†¡ ('s' + ê°ë„)
        function sendServoAngle() {
            const angle = servoAngleInput.value;
            // ì•„ë‘ì´ë…¸ ì½”ë“œì˜ 's' ëª…ë ¹ê³¼ serialReadNumber() í•¨ìˆ˜ì— ë§ê²Œ
            // 's'ì™€ ê°ë„ ìˆ«ìë¥¼ ë¶™ì—¬ì„œ ì „ì†¡í•©ë‹ˆë‹¤ (ì˜ˆ: "s90")
            const command = `s${angle}`;
            sendSerialData(command);
            statusDiv.textContent = `ìƒíƒœ: ì„œë³´ ëª…ë ¹ ('${command}') ì „ì†¡ ì™„ë£Œ.`;
        }
    </script>
</body>
</html>